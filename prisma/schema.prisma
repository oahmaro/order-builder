generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id        Int       @id @default(autoincrement())
  firstName String?
  lastName  String?
  username  String?   @unique
  email     String?   @unique
  password  String?
  role      UserRole  @default(USER)
  active    Boolean   @default(true)
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  auditLogs Audit[]
}

enum UserRole {
  USER
  ADMIN
}

model Customer {
  id          Int       @id @default(autoincrement())
  firstName   String
  lastName    String
  phones      Phone[]
  email       String?   @unique
  dateOfBirth String?
  createdAt   DateTime? @default(now())
  updatedAt   DateTime? @updatedAt

  orders    Order[]
  address   Address? @relation(fields: [addressId], references: [id])
  addressId Int?

  @@index([addressId])
}

model Phone {
  id          Int       @id @default(autoincrement())
  countryCode String
  dialingCode String
  number      String
  type        PhoneType @default(MOBILE)
  isPrimary   Boolean   @default(false)
  
  customerId  Int?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  companyId   Int?
  company     Company?  @relation(fields: [companyId], references: [id])

  @@unique([countryCode, dialingCode, number])
  @@index([customerId])
  @@index([companyId])
}

enum PhoneType {
  MOBILE
  HOME
  WORK
  OTHER
}

model Address {
  id            Int     @id @default(autoincrement())
  streetAddress String?
  aptSuite      String?
  city          String?
  stateProvince String?
  postalCode    String?
  country       String?
  latitude      Float?
  longitude     Float?

  company    Company?
  customers  Customer[]

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
}

model Company {
  id      Int     @id @default(autoincrement())
  name    String
  email   String
  phones  Phone[]

  addressId Int     @unique
  address   Address @relation(fields: [addressId], references: [id])

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  @@index([addressId])
}

model Frame {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  
  createdAt   DateTime? @default(now())
  updatedAt   DateTime? @updatedAt

  orderItems OrderItem[]
}

model Adhesion {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  
  createdAt   DateTime? @default(now())
  updatedAt   DateTime? @updatedAt

  orderItems OrderItem[]
}

model Print {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  
  createdAt   DateTime? @default(now())
  updatedAt   DateTime? @updatedAt

  orderItems OrderItem[]
}

model Description {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  
  createdAt   DateTime? @default(now())
  updatedAt   DateTime? @updatedAt

  orderItems OrderItem[]
}

model Passepartout {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  
  createdAt   DateTime? @default(now())
  updatedAt   DateTime? @updatedAt

  orderItems OrderItem[]
}

enum OrderStatus {
  PENDING     // The order has been placed but not yet processed.
  PROCESSING  // The order is being handled, items are being picked, and it's in the process of being fulfilled.
  SHIPPED     // The order has been shipped and is on its way to the customer.
  DELIVERED   // The customer has received the order successfully.
  CANCELLED   // The order was cancelled, either by the customer or due to some other reason.
  REFUNDED    // The payment for the order has been refunded to the customer.
  ON_HOLD     // The order is temporarily on hold, possibly awaiting some action or clarification.
}

model Order {
  id         Int         @id @default(autoincrement())
  customerId Int
  customer   Customer    @relation(fields: [customerId], references: [id])
  amountPaid Float
  status     OrderStatus
  orderItems OrderItem[]
  
  createdAt  DateTime?   @default(now())
  updatedAt  DateTime?   @updatedAt

  @@index([customerId])
}

model OrderItem {
  id          Int    @id @default(autoincrement())
  orderId     Int
  order       Order  @relation(fields: [orderId], references: [id])

  frameId     Int?
  frame       Frame? @relation(fields: [frameId], references: [id])

  adhesionId  Int?
  adhesion    Adhesion? @relation(fields: [adhesionId], references: [id])

  printId     Int?
  print       Print? @relation(fields: [printId], references: [id])

  descriptionId Int?
  description   Description? @relation(fields: [descriptionId], references: [id])

  passepartoutId Int?
  passepartout   Passepartout? @relation(fields: [passepartoutId], references: [id])

  height            Float
  width             Float
  passepartoutNum   Int
  passepartoutWidth Float
  glassTypes        Json
  unitPrice         Float
  quantity          Int
  price             Float
  notes             String?
  image             String?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  orderIndex Int @default(0)

  @@index([orderId])
  @@index([frameId])
  @@index([adhesionId])
  @@index([printId])
  @@index([descriptionId])
  @@index([passepartoutId])
}

model Audit {
  id         Int      @id @default(autoincrement())
  entityId   Int      
  entityType String   // e.g., "Print", "Order"
  action     String   // "CREATE", "UPDATE"
  changes    Json?    // Store what changed
  userId     Int
  user       User     @relation(fields: [userId], references: [id])
  timestamp  DateTime @default(now())

  @@index([userId])
  @@index([entityId, entityType])
}
